Bootstrap: docker
From: nvcr.io/nvidia/cuda:12.3.1-devel-ubuntu22.04


%post
    # Run scripts from source container
    . /.singularity.d/env/10-docker*.sh

    # Upgrade Ubuntu software
    apt-get -y update

    # GCC 11
    apt-get -y install g++-11 gcc-11

    # Cmake
    apt-get -y install cmake

    apt-get -y install pkg-config

    # Gstreamer with plugins
    apt-get -y install libgstreamer1.0-dev
    apt-get -y install libgstreamer-plugins-base1.0-dev
    apt-get -y install gstreamer1.0-plugins-good
    apt-get -y install gstreamer1.0-plugins-ugly

    apt-get install -y libglvnd0 libgl1 libglx0 libegl1
    apt-get install -y libglu1-mesa libxi-dev libxmu-dev libglu1-mesa-dev
    apt-get install -y libgl1-mesa-dev libegl1-mesa-dev

    # Install openMPI
    apt-get install -y openmpi-bin openmpi-common libopenmpi-dev libgtk2.0-dev

    apt-get install -y git

%environment
    . /.singularity.d/env/10-docker*.sh

%test
    # Basic tools
    nvcc --version
    cmake --version
    make -v
    gcc --version
    git --version

%runscript
    if [ $# -eq 0 ]
    then
        SERVER_PATH="${PWD}"
    elif [ $# -eq 1 ]
    then
        SERVER_PATH="$1"
    else
        echo "Too many arguments"
        exit -1
    fi

    mkdir "${SERVER_PATH}/build"
    cmake -S "${SERVER_PATH}" -B "${SERVER_PATH}/build" -DWINDOW_RENDERING=OFF -DCMAKE_BUILD_TYPE=Debug
    cmake --build "${SERVER_PATH}/build" --parallel 3 --target Simulation_server
    (cd "${SERVER_PATH}/build/" && ./Simulation_server)

%labels
    Author Piotr Nieciecki piotr.nieciecki01@gmail.com
    Version v1.1.0

%help
    This container is meant to build and run blood simulation server, which is stored
    in this repository: https://github.com/GPU-Blood-Cell-Simulation/Simulation-Server

    Default script takes path to simulation server main directory, builds it and run
    configured simulation.
